<!DOCTYPE html>ã€€
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <!-- Google Tag Manager -->
  <script>(function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-5GTPSHHJ');</script>
  <!-- End Google Tag Manager -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="google-site-verification" content="3rckRvHECynAe2w8OLIitJ65VhT8SjqYBJApRsXwBPs" />

  <title>AIcomment | è‡ªåˆ†ã®æ–‡ä½“ã‚’å†ç¾ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãƒ»ãƒªã‚¢ãºä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ« | Your Style, Your Reflection</title>
  <meta name="description"
    content="AIcommentã®ã€ŒMy Styleã€ã‚¨ãƒ³ã‚¸ãƒ³ãŒã‚ãªãŸã®æ–‡ç« ã®ç™–ã‚’å­¦ç¿’ã—ã€è‡ªç„¶ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ã‚’çˆ†é€Ÿã§ä½œæˆã€‚Mimic your own writing style with AIâ€”no fake citations, no hallucinations. A drafting assistant built for academic integrity.">
  <meta name="keywords"
    content="ãƒªã‚¢ãº, ãƒ¬ãƒãƒ¼ãƒˆ, å¤§å­¦, ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼, ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ AI, æ–‡ç« ä½œæˆ, è‡ªå‹•ç”Ÿæˆ, ãƒªã‚¢ãº ä»£è¡Œ, ãƒªã‚¢ãº ãƒã‚¿åˆ‡ã‚Œ, ãƒªã‚¢ãº çˆ†é€Ÿ, My Style, Reaction Paper AI, Reflection Paper Assistant, Response Paper, Personalized AI Writing">

  <meta property="og:title" content="AIcomment | Your Style, Your Reflection â€” ã‚ãªãŸã®ç­†è‡´ã‚’å†ç¾ã™ã‚‹ãƒªã‚¢ãºæ”¯æ´AI">
  <meta property="og:description"
    content="Mimic your own writing style with AI. No fake citations, no hallucinations. ã€ŒAIã£ã½ã•ã€ã¯ã‚‚ã†å’æ¥­ã€‚è‡ªåˆ†ã®æ–‡ä½“ã§è‡ªç„¶ãªãƒªã‚¢ãƒšã‚’ã‚µã‚¯ãƒƒã¨å®Œæˆã€‚">
  <meta property="og:url" content="https://aicomment-paper.vercel.app">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://aicomment-paper.vercel.app/ogp-image.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://aicomment-paper.vercel.app/">
  <meta name="robots" content="index, follow">

  <!-- hreflang: å¤šè¨€èªå¯¾å¿œ -->
  <link rel="alternate" hreflang="ja" href="https://aicomment-paper.vercel.app/">
  <link rel="alternate" hreflang="en" href="https://aicomment-paper.vercel.app/">
  <link rel="alternate" hreflang="x-default" href="https://aicomment-paper.vercel.app/">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="training_data.js"></script>
  <script src="training_data_en.js"></script>
  <style>
    /* ============================================
       DESIGN SYSTEM â€” Clean & White
       ============================================ */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #F9FAFB;
      --card: #FFFFFF;
      --text: #374151;
      --text-light: #6B7280;
      --text-muted: #9CA3AF;
      --accent: #3B82F6;
      --accent-hover: #2563EB;
      --accent-light: #DBEAFE;
      --accent-ultra-light: #EFF6FF;
      --border: #E5E7EB;
      --border-focus: #93C5FD;
      --success: #10B981;
      --success-light: #D1FAE5;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: 0.2s ease;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      font-weight: 400;
      min-height: 100vh;
    }

    /* ============================================
       HEADER
       ============================================ */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-inner {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #818CF8);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-badge {
      font-size: 11px;
      font-weight: 500;
      color: var(--accent);
      background: var(--accent-light);
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.02em;
    }

    /* ============================================
       MAIN LAYOUT â€” 2-Column Grid
       ============================================ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px 80px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }

    .col-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .col-right {
      position: sticky;
      top: 100px;
    }

    .gen-btn-wrap {
      margin-bottom: 0;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .col-right {
        position: static;
      }
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: var(--card);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: var(--shadow-lg);
      text-align: center;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .modal-box h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .modal-box p {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .btn-google {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text);
    }

    .btn-google:hover {
      box-shadow: var(--shadow-md);
      border-color: #93C5FD;
    }

    .btn-ad {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #3B82F6, #2563EB);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-ad:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-ad:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ad-countdown {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 12px;
    }

    .modal-skip {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 16px;
      cursor: pointer;
      text-decoration: underline;
    }

    .modal-skip:hover {
      color: var(--accent);
    }

    .premium-banner {
      background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
      border: 1px solid #BFDBFE;
      border-radius: var(--radius-sm);
      padding: 14px 18px;
      margin-top: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      line-height: 1.5;
    }

    .premium-banner .badge-pro {
      background: linear-gradient(135deg, #3B82F6, #8B5CF6);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .user-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .user-name {
      font-size: 12px;
      color: var(--text-light);
    }

    /* ============================================
       CARD COMPONENT
       ============================================ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: box-shadow var(--transition);
      animation: fadeUp 0.5s ease both;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .card:nth-child(2) {
      animation-delay: 0.08s;
    }

    .card:nth-child(3) {
      animation-delay: 0.16s;
    }

    .card:nth-child(4) {
      animation-delay: 0.24s;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .card-icon.style {
      background: #EDE9FE;
    }

    .card-icon.lecture {
      background: var(--accent-ultra-light);
    }

    .card-icon.adjust {
      background: #FEF3C7;
    }

    .card-icon.result {
      background: var(--success-light);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 1px;
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }

    textarea,
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--bg);
      transition: border-color var(--transition), box-shadow var(--transition);
      outline: none;
      line-height: 1.6;
    }

    textarea:focus,
    input[type="text"]:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    textarea::placeholder,
    input::placeholder {
      color: var(--text-muted);
    }

    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--bg);
      outline: none;
      cursor: pointer;
      transition: border-color var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    select:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      outline: none;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.15);
      opacity: 0;
      transition: opacity var(--transition);
    }

    .btn:hover::after {
      opacity: 1;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 2px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-lg {
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 600;
      border-radius: var(--radius);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-full {
      width: 100%;
    }

    /* ============================================
       STYLE ANALYSIS â€” My Style
       ============================================ */
    .style-saved-banner {
      display: none;
      align-items: center;
      gap: 8px;
      background: var(--success-light);
      color: #065F46;
      border: 1px solid #A7F3D0;
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
      animation: fadeUp 0.3s ease;
    }

    .style-saved-banner.show {
      display: flex;
    }

    .style-stats {
      display: none;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 16px;
    }

    .style-stats.show {
      display: grid;
    }

    .stat-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .style-patterns {
      display: none;
      margin-top: 12px;
      padding: 12px 16px;
      background: var(--accent-ultra-light);
      border: 1px solid var(--accent-light);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-light);
    }

    .style-patterns.show {
      display: block;
    }

    .style-patterns strong {
      color: var(--text);
    }

    .reset-style-btn {
      display: none;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      background: none;
      border: none;
      text-decoration: underline;
    }

    .reset-style-btn.show {
      display: inline-block;
    }

    /* ============================================
       PDF UPLOAD
       ============================================ */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
      margin-top: 12px;
      position: relative;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: var(--accent-ultra-light);
    }

    .upload-area.dragover {
      border-color: var(--accent);
      background: var(--accent-ultra-light);
    }

    .upload-area .upload-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .upload-area .upload-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .upload-area .upload-text strong {
      color: var(--accent);
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-name-display {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--success);
      font-weight: 500;
    }

    .file-name-display.show {
      display: flex;
    }

    .upload-formats {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .file-loading {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    .file-loading.show {
      display: flex;
    }

    .or-divider {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      margin: 14px 0;
      position: relative;
    }

    .or-divider::before,
    .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: calc(50% - 20px);
      height: 1px;
      background: var(--border);
    }

    .or-divider::before {
      left: 0;
    }

    .or-divider::after {
      right: 0;
    }

    /* ============================================
       QUALITY SLIDER
       ============================================ */
    .slider-container {
      padding: 4px 0;
    }

    .slider-track {
      position: relative;
      margin: 20px 0 12px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #DBEAFE, var(--accent));
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.35);
      cursor: pointer;
      transition: box-shadow var(--transition), transform var(--transition);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow: 0 2px 10px rgba(59, 130, 246, 0.5);
      transform: scale(1.1);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }

    .slider-label {
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
      transition: all var(--transition);
      text-align: center;
      flex: 1;
    }

    .slider-label:hover {
      color: var(--accent);
    }

    .slider-label.active {
      color: var(--accent);
      font-weight: 600;
    }

    .slider-current {
      text-align: center;
      margin-bottom: 4px;
    }

    .slider-current .level-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      padding: 4px 14px;
      border-radius: 20px;
    }

    .dept-select {
      margin-top: 20px;
    }

    /* ============================================
       RESULT AREA
       ============================================ */
    .result-card {
      display: block;
    }

    .result-text {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      font-size: 14px;
      line-height: 1.9;
      color: var(--text);
      min-height: 100px;
      white-space: pre-wrap;
    }

    .result-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .copy-feedback {
      display: none;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--success);
      font-weight: 500;
      margin-top: 10px;
      animation: fadeUp 0.3s ease;
    }

    .copy-feedback.show {
      display: flex;
    }

    /* ============================================
       LOADING SPINNER
       ============================================ */
    .loading {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 32px 0;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 600px) {
      .container {
        padding: 16px 16px 60px;
      }

      .card {
        padding: 20px;
      }

      .style-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-item {
        padding: 8px;
      }

      .stat-value {
        font-size: 16px;
      }

      .result-actions {
        flex-direction: column;
      }

      .header-inner {
        padding: 0 16px;
      }
    }

    /* ============================================
       LANGUAGE TOGGLE
       ============================================ */
    .lang-toggle {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--bg);
      border-radius: 8px;
      padding: 2px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }

    .lang-toggle span {
      padding: 4px 10px;
      border-radius: 6px;
      transition: all 0.2s ease;
      color: var(--text-muted);
    }

    .lang-toggle span.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    /* ============================================
       UTILITY
       ============================================ */
    .mt-12 {
      margin-top: 12px;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .hidden {
      display: none !important;
    }

    /* ============================================
       TOAST NOTIFICATION
       ============================================ */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, var(--primary), #4f46e5);
      color: #fff;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 30px rgba(79, 70, 229, 0.35);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 90vw;
      text-align: center;
      line-height: 1.6;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5GTPSHHJ" height="0" width="0"
      style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- ========== HEADER ========== -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">ğŸ“</div>
        <div class="logo-text">AI<span>ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼</span></div>
      </div>
      <div class="user-bar" id="user-bar">
        <div class="lang-toggle" id="lang-toggle" onclick="toggleLang()">
          <span id="lang-ja" class="active">JA</span>
          <span id="lang-en">EN</span>
        </div>
        <div class="header-badge" data-i18n="headerBadge">å­¦ç¿’æ”¯æ´ãƒ„ãƒ¼ãƒ«</div>
      </div>
    </div>
  </header>

  <!-- ========== MAIN ========== -->
  <main class="container">
    <div class="main-grid">
      <div class="col-left">

        <!-- ===== SECTION 1: My Style ===== -->
        <section class="card" id="style-section">
          <div class="card-header">
            <div class="card-icon style">âœï¸</div>
            <div>
              <div class="card-title" data-i18n="styleTitle">My Style</div>
              <div class="card-subtitle" data-i18n="styleSubtitle">
                ã‚ãªãŸã®æ–‡ç« ã®ç™–ã‚’å­¦ç¿’ã—ã€è‡ªç„¶ãªæ–‡ç« ã‚’å†ç¾ã—ã¾ã™ã€‚éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã™ã‚‹ã“ã¨ã§ã€ç”Ÿæˆç²¾åº¦ãŒæ ¼æ®µã«å‘ä¸Šã—ã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="style-saved-banner" id="style-banner">
            <span data-i18n="styleSaved">âœ… æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</span>
          </div>

          <div id="style-input-area">
            <label for="style-text" data-i18n="styleLabel">éå»ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’è²¼ã‚Šä»˜ã‘</label>
            <textarea id="style-text" data-i18n-placeholder="stylePlaceholder"
              placeholder="ã“ã“ã«éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚„ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚&#10;èªå°¾ã®ç™–ã‚„æ¼¢å­—ã®ä½¿ã„æ–¹ã€æ–‡ç« ã®ãƒªã‚ºãƒ ã‚’è§£æã—ã¾ã™ã€‚"></textarea>
            <button class="btn btn-primary mt-16" id="analyze-btn" onclick="analyzeStyle()" data-action="analyze-style"
              data-lang="ja">
              <span data-i18n="analyzeBtn">ğŸ” æ–‡ä½“ã‚’è§£æãƒ»åŒæœŸ</span>
            </button>
          </div>

          <div class="style-stats" id="style-stats">
            <div class="stat-item">
              <div class="stat-value" id="stat-kanji">â€”</div>
              <div class="stat-label" data-i18n="statKanji">æ¼¢å­—ç‡</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-avg-len">â€”</div>
              <div class="stat-label" data-i18n="statAvgLen">å¹³å‡æ–‡é•·</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-endings">â€”</div>
              <div class="stat-label" data-i18n="statEndings">èªå°¾ã‚¿ã‚¤ãƒ—</div>
            </div>
          </div>

          <div class="style-patterns" id="style-patterns"></div>

          <button class="reset-style-btn" id="reset-style-btn" onclick="resetStyle()" data-action="reset-style"
            data-lang="ja">
            <span data-i18n="resetStyle">æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</span>
          </button>
        </section>

        <!-- ===== SECTION 2: è¬›ç¾©ã‚½ãƒ¼ã‚¹ ===== -->
        <section class="card" id="lecture-section">
          <div class="card-header">
            <div class="card-icon lecture">ğŸ“–</div>
            <div>
              <div class="card-title" data-i18n="lectureTitle">è¬›ç¾©ã‚½ãƒ¼ã‚¹å…¥åŠ›</div>
              <div class="card-subtitle" data-i18n="lectureSubtitle">è¬›ç¾©åã¨ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
          </div>

          <label for="lecture-name" data-i18n="lectureName">è¬›ç¾©å</label>
          <input type="text" id="lecture-name" data-i18n-placeholder="lectureNamePH" placeholder="ä¾‹ï¼šç¤¾ä¼šå­¦æ¦‚è«–ã€ãƒ¡ãƒ‡ã‚£ã‚¢è«–â…¡">

          <div class="mt-16">
            <label for="resume-text" data-i18n="resumeLabel">ãƒ¬ã‚¸ãƒ¥ãƒ¡å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‰</label>
            <textarea id="resume-text" data-i18n-placeholder="resumePH"
              placeholder="ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ä¸‹ã®æ¬„ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"></textarea>
          </div>

          <div class="or-divider" data-i18n="orDivider">ã¾ãŸã¯</div>

          <div class="upload-area" id="upload-area">
            <input type="file" accept=".pdf,.docx,.pptx" id="file-input" onchange="handleFileUpload(event)">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text" data-i18n="uploadText"><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
            <div class="upload-formats" data-i18n="uploadFormats">å¯¾å¿œå½¢å¼ï¼šPDF, Word (.docx), PowerPoint (.pptx)</div>
          </div>
          <div class="file-name-display" id="file-name-display">
            ğŸ“ <span id="file-name-text"></span>
          </div>
          <div class="file-loading" id="file-loading">
            <div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>
            <span data-i18n="fileLoading">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</span>
          </div>
        </section>

        <!-- ===== SECTION 3: èª¿æ•´ãƒ‘ãƒãƒ« ===== -->
        <section class="card" id="adjust-section">
          <div class="card-header">
            <div class="card-icon adjust">ğŸ›ï¸</div>
            <div>
              <div class="card-title" data-i18n="adjustTitle">èª¿æ•´ãƒ‘ãƒãƒ«</div>
              <div class="card-subtitle" data-i18n="adjustSubtitle">ç”Ÿæˆã™ã‚‹æ–‡ç« ã®ãƒ¬ãƒ™ãƒ«ã¨ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š</div>
            </div>
          </div>

          <div class="slider-container">
            <label data-i18n="sliderLabel">å¯¾è±¡ãƒ¬ãƒ™ãƒ«</label>
            <div class="slider-current">
              <span class="level-badge" id="level-badge">50% â€” å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰</span>
            </div>
            <div class="slider-track">
              <input type="range" id="quality-slider" min="1" max="5" value="3" step="1"
                oninput="updateSlider(this.value)">
            </div>
            <div class="slider-labels">
              <span class="slider-label" data-i18n="sliderL1" onclick="setSlider(1)">10%<br>ä¸­å­¦ç”Ÿ</span>
              <span class="slider-label" data-i18n="sliderL2" onclick="setSlider(2)">30%<br>é«˜æ ¡ç”Ÿ</span>
              <span class="slider-label active" data-i18n="sliderL3" onclick="setSlider(3)">50%<br>å¤§å­¦ç”Ÿ</span>
              <span class="slider-label" data-i18n="sliderL4" onclick="setSlider(4)">70%<br>çœŸé¢ç›®</span>
              <span class="slider-label" data-i18n="sliderL5" onclick="setSlider(5)">90%<br>å¤§å­¦é™¢</span>
            </div>
          </div>

          <!-- ç›®æ¨™æ–‡å­—æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
          <div class="length-slider mt-20">
            <label data-i18n="lengthLabel">ç›®æ¨™æ–‡å­—æ•°</label>
            <div class="slider-current">
              <span class="level-badge" id="length-badge">300æ–‡å­—</span>
            </div>
            <div class="slider-track">
              <input type="range" id="length-slider" min="100" max="600" value="300" step="100"
                oninput="updateLengthSlider(this.value)">
            </div>
          </div>

          <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
          <div class="count-mode mt-16">
            <label data-i18n="countModeLabel">ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼</label>
            <select id="count-mode">
              <option value="char" data-i18n="countChar">æ–‡å­—æ•°</option>
              <option value="word" data-i18n="countWord">èªæ•°ï¼ˆå¥èª­ç‚¹é™¤å¤–ï¼‰</option>
            </select>
          </div>

          <div class="dept-select mt-16">
            <label for="dept-filter" data-i18n="deptLabel">å­¦éƒ¨ãƒˆãƒ¼ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <select id="dept-filter">
              <option value="none" data-i18n="deptNone">ãªã—</option>
              <option value="science-eng" data-i18n="deptSci">ç†ç³»ãƒ»å·¥å­¦éƒ¨</option>
              <option value="social-psych" data-i18n="deptSoc">ç¤¾ä¼šãƒ»å¿ƒç†å­¦éƒ¨</option>
              <option value="econ-biz" data-i18n="deptEcon">çµŒæ¸ˆãƒ»çµŒå–¶å­¦éƒ¨</option>
              <option value="literature-phil" data-i18n="deptLit">æ–‡å­¦ãƒ»å“²å­¦éƒ¨</option>
            </select>
          </div>
        </section>

        <!-- ===== GENERATE BUTTON ===== -->
        <div class="gen-btn-wrap">
          <button class="btn btn-primary btn-lg btn-full" id="generate-btn" onclick="handleGenerate()"
            data-action="generate-paper" data-lang="ja">
            <span data-i18n="generateBtn">ğŸš€ ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸‹æ›¸ãï¼‰ã‚’ç”Ÿæˆ</span>
          </button>
          <div id="daily-limit-text" style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:8px;">
            ä»Šæ—¥ã®æ®‹ã‚Šåˆ©ç”¨æ ï¼š5 / 5
          </div>
        </div>

      </div><!-- /col-left -->
      <div class="col-right">

        <!-- ===== SECTION 4: ç”Ÿæˆçµæœ ===== -->
        <section class="card result-card" id="result-section">
          <div class="card-header">
            <div class="card-icon result">âœ¨</div>
            <div>
              <div class="card-title" data-i18n="resultTitle">ç”Ÿæˆçµæœ</div>
              <div class="card-subtitle" data-i18n="resultSubtitle">ã‚ãªãŸã®æ–‡ä½“ã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼</div>
            </div>
          </div>

          <div id="result-empty" class="result-text"
            style="text-align:center; color: var(--text-muted); padding: 40px 20px;">
            <span data-i18n="resultEmpty">âœ¨ ã“ã“ã«ç”ŸæˆçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" data-i18n="loadingText">ã‚ãªãŸã®æ–‡ä½“ã§ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦</div>
          </div>

          <div id="result-content" class="hidden">
            <div class="result-text" id="result-text"></div>
            <div class="result-actions">
              <button class="btn btn-success" onclick="copyResult()"><span data-i18n="copyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</span></button>
              <button class="btn btn-secondary" onclick="generatePaper()"><span data-i18n="regenBtn">ğŸ”„
                  å†ç”Ÿæˆ</span></button>
            </div>
            <div class="copy-feedback" id="copy-feedback">
              <span data-i18n="copyFeedback">âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</span>
            </div>
          </div>
          <div class="premium-banner" id="premium-banner">
            <span class="badge-pro">PRO</span>
            <span data-i18n="premiumBanner">åºƒå‘Šãªã—ãƒ»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆãƒ»é«˜ç²¾åº¦AIã§ã€ã•ã‚‰ã«å¿«é©ãªä½œæˆä½“é¨“ã‚’ã€‚</span>
          </div>
        </section>

      </div><!-- /col-right -->
    </div><!-- /main-grid -->
  </main>

  <!-- ========== MODALS ========== -->
  <div class="modal-overlay" id="login-modal">
    <div class="modal-box">
      <div class="modal-icon">ğŸ”</div>
      <h3 data-i18n="loginTitle">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç¶™ç¶šåˆ©ç”¨</h3>
      <p data-i18n="loginDesc">æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç²¾åº¦å‘ä¸Šã®ãŸã‚ã«ã€<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
      <button class="btn-google" onclick="mockLogin()">
        <svg width="20" height="20" viewBox="0 0 48 48">
          <path fill="#4285F4"
            d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
          <path fill="#34A853"
            d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
          <path fill="#FBBC05"
            d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
          <path fill="#EA4335"
            d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
        </svg>
        <span data-i18n="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
      </button>
    </div>
  </div>

  <div class="modal-overlay" id="ad-modal">
    <div class="modal-box">
      <div class="modal-icon">ğŸ¬</div>
      <h3 data-i18n="adTitle">åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ</h3>
      <p data-i18n="adDesc">åºƒå‘Šã®è¦–è´å¾Œã€è‡ªå‹•çš„ã«ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚<br>åºƒå‘Šãªã—ã§åˆ©ç”¨ã™ã‚‹ã«ã¯ã€PROãƒ—ãƒ©ãƒ³ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚</p>
      <button class="btn-ad" id="ad-watch-btn" onclick="watchAd()">
        <span data-i18n="adBtn">â–¶ï¸ åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ</span>
      </button>
      <div class="ad-countdown" id="ad-countdown"></div>
    </div>
  </div>

  <!-- ========== JAVASCRIPT ========== -->
  <script>
    /* ============================================
       STATE
       ============================================ */
    let styleData = null;
    let usageCount = parseInt(localStorage.getItem('ac_usageCount') || '0');
    let isLoggedIn = localStorage.getItem('ac_loggedIn') === 'true';
    let userTier = localStorage.getItem('ac_userTier') || 'free'; // free | premium

    /* â€” Daily Limit â€” */
    const DAILY_LIMIT = 5;

    function getDailyUsage() {
      try {
        const data = JSON.parse(localStorage.getItem('ac_dailyUsage') || '{}');
        const today = new Date().toISOString().slice(0, 10);
        return (data.date === today) ? data.count : 0;
      } catch { return 0; }
    }

    function incrementDailyUsage() {
      const today = new Date().toISOString().slice(0, 10);
      const current = getDailyUsage();
      localStorage.setItem('ac_dailyUsage', JSON.stringify({ date: today, count: current + 1 }));
      updateDailyLimitUI();
    }

    function updateDailyLimitUI() {
      const remaining = DAILY_LIMIT - getDailyUsage();
      const el = document.getElementById('daily-limit-text');
      if (!el) return;
      el.textContent = currentLang === 'en'
        ? `Remaining today: ${remaining} / ${DAILY_LIMIT}`
        : `ä»Šæ—¥ã®æ®‹ã‚Šåˆ©ç”¨æ ï¼š${remaining} / ${DAILY_LIMIT}`;
      const btn = document.getElementById('generate-btn');
      if (remaining <= 0) {
        btn.disabled = true;
      } else {
        btn.disabled = false;
      }
    }

    /* ============================================
       i18n â€” LANGUAGE SYSTEM
       ============================================ */
    let currentLang = (function () {
      const saved = localStorage.getItem('ac_lang');
      if (saved) return saved;
      const nav = (navigator.language || 'en').toLowerCase();
      const lang = nav.startsWith('ja') ? 'ja' : 'en';
      localStorage.setItem('ac_lang', lang);
      return lang;
    })();

    const uiText = {
      ja: {
        /* â€” Header â€” */
        headerBadge: 'å­¦ç¿’æ”¯æ´ãƒ„ãƒ¼ãƒ«',
        /* â€” Style Section â€” */
        styleTitle: 'My Style',
        styleSubtitle: 'ã‚ãªãŸã®æ–‡ç« ã®ç™–ã‚’å­¦ç¿’ã—ã€è‡ªç„¶ãªæ–‡ç« ã‚’å†ç¾ã—ã¾ã™ã€‚éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã™ã‚‹ã“ã¨ã§ã€ç”Ÿæˆç²¾åº¦ãŒæ ¼æ®µã«å‘ä¸Šã—ã¾ã™ã€‚',
        styleSaved: 'âœ… æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™',
        styleLabel: 'éå»ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’è²¼ã‚Šä»˜ã‘',
        stylePlaceholder: 'ã“ã“ã«éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚„ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚\nèªå°¾ã®ç™–ã‚„æ¼¢å­—ã®ä½¿ã„æ–¹ã€æ–‡ç« ã®ãƒªã‚ºãƒ ã‚’è§£æã—ã¾ã™ã€‚',
        analyzeBtn: 'ğŸ” æ–‡ä½“ã‚’è§£æãƒ»åŒæœŸ',
        statKanji: 'æ¼¢å­—ç‡',
        statAvgLen: 'å¹³å‡æ–‡é•·',
        statEndings: 'èªå°¾ã‚¿ã‚¤ãƒ—',
        resetStyle: 'æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ',
        /* â€” Lecture Section â€” */
        lectureTitle: 'è¬›ç¾©ã‚½ãƒ¼ã‚¹å…¥åŠ›',
        lectureSubtitle: 'è¬›ç¾©åã¨ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
        lectureName: 'è¬›ç¾©å',
        lectureNamePH: 'ä¾‹ï¼šç¤¾ä¼šå­¦æ¦‚è«–ã€ãƒ¡ãƒ‡ã‚£ã‚¢è«–â…¡',
        resumeLabel: 'ãƒ¬ã‚¸ãƒ¥ãƒ¡å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‰',
        resumePH: 'ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ä¸‹ã®æ¬„ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚',
        orDivider: 'ã¾ãŸã¯',
        uploadText: '<strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ',
        uploadFormats: 'å¯¾å¿œå½¢å¼ï¼šPDF, Word (.docx), PowerPoint (.pptx)',
        fileLoading: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...',
        /* â€” Adjustment Panel â€” */
        adjustTitle: 'èª¿æ•´ãƒ‘ãƒãƒ«',
        adjustSubtitle: 'ç”Ÿæˆã™ã‚‹æ–‡ç« ã®ãƒ¬ãƒ™ãƒ«ã¨ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š',
        sliderLabel: 'å¯¾è±¡ãƒ¬ãƒ™ãƒ«',
        sliderL1: '10%<br>ä¸­å­¦ç”Ÿ',
        sliderL2: '30%<br>é«˜æ ¡ç”Ÿ',
        sliderL3: '50%<br>å¤§å­¦ç”Ÿ',
        sliderL4: '70%<br>çœŸé¢ç›®',
        sliderL5: '90%<br>å¤§å­¦é™¢',
        deptLabel: 'å­¦éƒ¨ãƒˆãƒ¼ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
        deptNone: 'ãªã—',
        deptSci: 'ç†ç³»ãƒ»å·¥å­¦éƒ¨',
        deptSoc: 'ç¤¾ä¼šãƒ»å¿ƒç†å­¦éƒ¨',
        deptEcon: 'çµŒæ¸ˆãƒ»çµŒå–¶å­¦éƒ¨',
        deptLit: 'æ–‡å­¦ãƒ»å“²å­¦éƒ¨',
        /* â€” Generate / Result â€” */
        generateBtn: 'ğŸš€ ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸‹æ›¸ãï¼‰ã‚’ç”Ÿæˆ',
        resultTitle: 'ç”Ÿæˆçµæœ',
        resultSubtitle: 'ã‚ãªãŸã®æ–‡ä½“ã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼',
        resultEmpty: 'âœ¨ ã“ã“ã«ç”ŸæˆçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™',
        loadingText: 'ã‚ãªãŸã®æ–‡ä½“ã§ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦',
        copyBtn: 'ğŸ“‹ ã‚³ãƒ”ãƒ¼',
        regenBtn: 'ğŸ”„ å†ç”Ÿæˆ',
        copyFeedback: 'âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
        premiumBanner: 'åºƒå‘Šãªã—ãƒ»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆãƒ»é«˜ç²¾åº¦AIã§ã€ã•ã‚‰ã«å¿«é©ãªä½œæˆä½“é¨“ã‚’ã€‚',
        /* â€” Modals â€” */
        loginTitle: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç¶™ç¶šåˆ©ç”¨',
        loginDesc: 'æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç²¾åº¦å‘ä¸Šã®ãŸã‚ã«ã€<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',
        loginBtn: 'Googleã§ãƒ­ã‚°ã‚¤ãƒ³',
        adTitle: 'åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ',
        adDesc: 'åºƒå‘Šã®è¦–è´å¾Œã€è‡ªå‹•çš„ã«ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚<br>åºƒå‘Šãªã—ã§åˆ©ç”¨ã™ã‚‹ã«ã¯ã€PROãƒ—ãƒ©ãƒ³ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚',
        adBtn: 'â–¶ï¸ åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ',
        /* â€” User State â€” */
        loggedIn: 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­',
        /* â€” Alerts â€” */
        alertNoLecture: 'è¬›ç¾©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
        alertNoResume: 'ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
        alertUploadLimit: 'ãƒ•ã‚¡ã‚¤ãƒ«ã¯1ã¤ã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼ˆç„¡æ–™ç‰ˆï¼‰ã€‚\nè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±åˆã«ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ã§ã™ã€‚',
        /* â€” Toast â€” */
        toastLevelDetected: (n, label) => `ğŸ“Š è‡ªå‹•åˆ¤å®šï¼šLevel ${n}ï¼ˆ${label}ï¼‰`,
        toastStyleHistoryStored: (c, limit) => `ğŸ“š æ–‡ä½“å­¦ç¿’ï¼š${c}/${limit}ä»¶ã‚’è¨˜æ†¶ã—ã¾ã—ãŸ`,
        toastStyleHistoryFull: (c, maxFree, maxPremium) => `ğŸ“š æ–‡ä½“å­¦ç¿’ï¼š${c}/${maxFree}ä»¶ï¼ˆä¸Šé™ï¼‰\nâ€»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§${maxPremium}ä»¶ã¾ã§è¨˜æ†¶ã‚’æ‹¡å¼µã§ãã¾ã™`,
        toastStyleDuplicate: 'ğŸ“ ã“ã®æ–‡ç« ã¯æ—¢ã«å­¦ç¿’æ¸ˆã¿ã§ã™',
        /* â€” New Features â€” */
        lengthLabel: 'ç›®æ¨™æ–‡å­—æ•°',
        lengthUnit: 'æ–‡å­—',
        countModeLabel: 'ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼',
        countChar: 'æ–‡å­—æ•°',
        countWord: 'èªæ•°ï¼ˆå¥èª­ç‚¹é™¤å¤–ï¼‰',
        alertDailyLimit: 'æœ¬æ—¥ã®åˆ©ç”¨å›æ•°ãŒä¸Šé™ï¼ˆ5å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚\næ˜æ—¥ã¾ãŸåˆ©ç”¨ã§ãã¾ã™ã€‚',
      },
      en: {
        /* â€” Header â€” */
        headerBadge: 'Learning Tool',
        /* â€” Style Section â€” */
        styleTitle: 'My Style',
        styleSubtitle: 'Learns your writing habits for natural results. Uses past context to improve accuracy.',
        styleSaved: 'âœ… Style data synced',
        styleLabel: 'Paste a previous report or comment',
        stylePlaceholder: 'Paste your previous writing sample here.\nThe engine will analyze sentence structure, tone, and vocabulary patterns.',
        analyzeBtn: 'ğŸ” Analyze & Sync',
        statKanji: 'Avg Word Len',
        statAvgLen: 'Avg Sentence',
        statEndings: 'Tone',
        resetStyle: 'Reset style data',
        /* â€” Lecture Section â€” */
        lectureTitle: 'Source Material',
        lectureSubtitle: 'Enter lecture name and source content',
        lectureName: 'Lecture name',
        lectureNamePH: 'e.g. Introduction to Sociology, Media Theory II',
        resumeLabel: 'Source content (text input)',
        resumePH: 'Paste the lecture notes or source material here, or upload a file below.',
        orDivider: 'or',
        uploadText: '<strong>Drop files here</strong> or click to upload.',
        uploadFormats: 'Supported: PDF, Word (.docx), PowerPoint (.pptx)',
        fileLoading: 'Processing document...',
        /* â€” Adjustment Panel â€” */
        adjustTitle: 'Parameters',
        adjustSubtitle: 'Configure output complexity and tone',
        sliderLabel: 'Lexical Complexity',
        sliderL1: '10%<br>Basic',
        sliderL2: '30%<br>Casual',
        sliderL3: '50%<br>Standard',
        sliderL4: '70%<br>Advanced',
        sliderL5: '90%<br>Academic',
        deptLabel: 'Department tone (optional)',
        deptNone: 'None',
        deptSci: 'Science / Engineering',
        deptSoc: 'Social Sciences / Psychology',
        deptEcon: 'Economics / Business',
        deptLit: 'Literature / Philosophy',
        /* â€” Generate / Result â€” */
        generateBtn: 'ğŸš€ Generate',
        resultTitle: 'Output',
        resultSubtitle: 'Reflection paper generated in your writing style',
        resultEmpty: 'âœ¨ Output will appear here',
        loadingText: 'Generating draft in your styleâ€¦',
        copyBtn: 'ğŸ“‹ Copy to Clipboard',
        regenBtn: 'ğŸ”„ Regenerate',
        copyFeedback: 'âœ… Copied to clipboard',
        premiumBanner: 'No ads. Multi-file processing. Higher accuracy. Upgrade to PRO.',
        /* â€” Modals â€” */
        loginTitle: 'Sign in to continue',
        loginDesc: 'Sign in with Google to save your style data<br>and improve generation accuracy.',
        loginBtn: 'Sign in with Google',
        adTitle: 'Watch an ad to generate',
        adDesc: 'Generation will begin automatically after the ad.<br>Upgrade to PRO for ad-free access.',
        adBtn: 'â–¶ï¸ Watch ad & generate',
        /* â€” User State â€” */
        loggedIn: 'Signed in',
        /* â€” Alerts â€” */
        alertNoLecture: 'Please enter a lecture name.',
        alertNoResume: 'Please enter source material content.',
        alertUploadLimit: 'Error: Upload limit exceeded (1 file maximum).\nMultiple file processing requires a Premium plan.',
        /* â€” Toast â€” */
        toastLevelDetected: (n, label) => `Analysis complete: Level ${n} detected. Parameters updated.`,
        toastStyleHistoryStored: (c, limit) => `Style history: ${c}/${limit} samples stored.`,
        toastStyleHistoryFull: (c, maxFree, maxPremium) => `Style history: ${c}/${maxFree} (limit reached).\nUpgrade to Premium for up to ${maxPremium} samples.`,
        toastStyleDuplicate: 'This text has already been analyzed.',
        /* â€” New Features â€” */
        lengthLabel: 'Target Length',
        lengthUnit: 'words',
        countModeLabel: 'Count Mode',
        countChar: 'Character Count',
        countWord: 'Word Count',
        alertDailyLimit: 'Daily usage limit reached (5/5).\nPlease come back tomorrow.',
      },
    };

    /* ============================================
       STYLE ANALYSIS TRANSLATIONS
       ============================================ */
    const translations = {
      ja: {
        kanji: 'æ¼¢å­—ç‡',
        length: 'å¹³å‡æ–‡é•·',
        endings: 'æ–‡æœ«è¡¨ç¾',
        patterns: 'æ¤œå‡ºã•ã‚ŒãŸèªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š',
        freqLabel: 'é »å‡ºè¡¨ç¾ï¼š',
        unit: 'å­—',
        none: 'ãªã—',
        separator: 'ã€',
        styleTypeMap: {
          'ã ãƒ»ã§ã‚ã‚‹èª¿': 'ã ãƒ»ã§ã‚ã‚‹èª¿',
          'ã§ã™ãƒ»ã¾ã™èª¿': 'ã§ã™ãƒ»ã¾ã™èª¿',
          'æ··åœ¨å‹': 'æ··åœ¨å‹',
          'Academic': 'ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯',
          'Semi-Formal': 'ã‚»ãƒŸãƒ•ã‚©ãƒ¼ãƒãƒ«',
          'Casual': 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«',
          'Personal': 'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«',
          'Neutral': 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«',
        },
      },
      en: {
        kanji: 'Avg. Word Len',
        length: 'Avg. Sent. Len',
        endings: 'Tone',
        patterns: 'Detected Patterns:',
        freqLabel: 'Frequent Expressions:',
        unit: 'Words',
        none: 'None',
        separator: ', ',
        styleTypeMap: {
          'ã ãƒ»ã§ã‚ã‚‹èª¿': 'Direct (da/dearu)',
          'ã§ã™ãƒ»ã¾ã™èª¿': 'Polite (desu/masu)',
          'æ··åœ¨å‹': 'Mixed',
          'Academic': 'Academic',
          'Semi-Formal': 'Semi-Formal',
          'Casual': 'Casual',
          'Personal': 'Personal',
          'Neutral': 'Neutral',
        },
      },
    };

    /** Get the active phrase pool */
    function getActiveLang() {
      return currentLang === 'en' ? (typeof LANG_EN !== 'undefined' ? LANG_EN : LANG) : LANG;
    }

    /** Get a UI string by key */
    function t(key) {
      return (uiText[currentLang] || uiText.ja)[key] || (uiText.ja[key] || key);
    }

    /** Toggle language and re-render UI */
    function toggleLang() {
      currentLang = currentLang === 'ja' ? 'en' : 'ja';
      localStorage.setItem('ac_lang', currentLang);
      applyLanguage();
    }

    /** Apply current language to all data-i18n elements */
    function applyLanguage() {
      const dict = uiText[currentLang] || uiText.ja;

      // 1. Swap text content for data-i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key] !== undefined) {
          el.innerHTML = dict[key];
        }
      });

      // 2. Swap placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (dict[key] !== undefined) {
          el.placeholder = dict[key];
        }
      });

      // 3. Update toggle active state
      document.getElementById('lang-ja').classList.toggle('active', currentLang === 'ja');
      document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');

      // 4. Update HTML lang attribute and page title
      document.documentElement.lang = currentLang === 'ja' ? 'ja' : 'en';
      document.title = currentLang === 'en'
        ? 'AIcomment | Your Style, Your Reflection'
        : 'AIcomment | è‡ªåˆ†ã®æ–‡ä½“ã‚’å†ç¾ã™ã‚‹ãƒªã‚¢ãºä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«';

      // Update data-lang on tracked buttons
      document.querySelectorAll('[data-lang]').forEach(el => {
        el.setAttribute('data-lang', currentLang);
      });

      // 5. Re-render slider label
      const slider = document.getElementById('quality-slider');
      if (slider) updateSlider(slider.value);

      // 6. Sync length slider for language
      syncLengthSliderLang();

      // 7. Update daily limit text
      updateDailyLimitUI();

      // 8. Sync style analysis labels
      syncStyleLabels();

      // 9. Update header if logged in
      updateHeaderUser();

      // 10. Update footer disclaimer language
      if (typeof updateFooterDisclaimer === 'function') updateFooterDisclaimer();
    }

    /* ============================================
       LENGTH SLIDER & COUNT MODE
       ============================================ */
    function updateLengthSlider(val) {
      val = parseInt(val);
      const unit = t('lengthUnit');
      document.getElementById('length-badge').textContent = `${val}${unit}`;
    }

    function syncLengthSliderLang() {
      const slider = document.getElementById('length-slider');
      if (!slider) return;
      if (currentLang === 'en') {
        slider.min = 50; slider.max = 250; slider.step = 50;
        if (parseInt(slider.value) > 250) slider.value = 150;
      } else {
        slider.min = 100; slider.max = 600; slider.step = 100;
        if (parseInt(slider.value) < 100) slider.value = 300;
      }
      updateLengthSlider(slider.value);
    }

    function countText(text, mode) {
      if (!text) return 0;
      if (currentLang === 'en') {
        // EN: word count
        return text.trim().split(/\s+/).filter(w => w.length > 0).length;
      }
      if (mode === 'word') {
        // JA: å¥èª­ç‚¹ãƒ»è¨˜å·ãƒ»ç©ºç™½ãƒ»æ”¹è¡Œã‚’é™¤å¤–ã—ãŸç´”ç²‹ãªæ–‡å­—æ•°
        return text.replace(/[ã€ã€‚ï¼ï¼Ÿ!?,\.\s\n]/g, '').length;
      }
      return text.length; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ–‡å­—æ•°
    }

    /* ============================================
       3-STAGE UX GATE
       ============================================ */
    function handleGenerate() {
      const lectureName = document.getElementById('lecture-name').value.trim();
      const resumeText = document.getElementById('resume-text').value.trim();
      if (!lectureName) { alert(t('alertNoLecture')); return; }
      if (!resumeText) { alert(t('alertNoResume')); return; }

      // Daily limit check
      if (getDailyUsage() >= DAILY_LIMIT) {
        alert(t('alertDailyLimit'));
        return;
      }

      // Stage 1: Free trial (1st & 2nd use) â€” no gates
      if (usageCount < 2) {
        proceedGeneration();
        return;
      }
      // Stage 2: Require login from 3rd use
      if (!isLoggedIn) {
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      // Stage 3: Show ad (unless premium)
      if (userTier !== 'premium') {
        document.getElementById('ad-modal').classList.add('show');
        return;
      }
      // Premium â€” straight through
      proceedGeneration();
    }

    function proceedGeneration() {
      usageCount++;
      localStorage.setItem('ac_usageCount', usageCount);
      incrementDailyUsage();
      generatePaper();
    }

    function mockLogin() {
      isLoggedIn = true;
      localStorage.setItem('ac_loggedIn', 'true');
      document.getElementById('login-modal').classList.remove('show');
      updateHeaderUser();
      // After login, show ad modal
      if (userTier !== 'premium') {
        setTimeout(() => {
          document.getElementById('ad-modal').classList.add('show');
        }, 300);
      } else {
        proceedGeneration();
      }
    }

    function watchAd() {
      const btn = document.getElementById('ad-watch-btn');
      const cdEl = document.getElementById('ad-countdown');
      btn.disabled = true;
      btn.textContent = 'â³ è¦–è´ä¸­...';
      let sec = 5;
      cdEl.textContent = `ã‚ã¨ ${sec} ç§’...`;
      const timer = setInterval(() => {
        sec--;
        if (sec <= 0) {
          clearInterval(timer);
          cdEl.textContent = '';
          btn.disabled = false;
          btn.innerHTML = 'â–¶ï¸ åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ';
          document.getElementById('ad-modal').classList.remove('show');
          proceedGeneration();
        } else {
          cdEl.textContent = `ã‚ã¨ ${sec} ç§’...`;
        }
      }, 1000);
    }

    function updateHeaderUser() {
      const bar = document.getElementById('user-bar');
      const langToggle = `
        <div class="lang-toggle" id="lang-toggle" onclick="toggleLang()">
          <span id="lang-ja" class="${currentLang === 'ja' ? 'active' : ''}">JA</span>
          <span id="lang-en" class="${currentLang === 'en' ? 'active' : ''}">EN</span>
        </div>`;
      if (isLoggedIn) {
        bar.innerHTML = `
          ${langToggle}
          <div class="user-avatar">ğŸ‘¤</div>
          <span class="user-name">${t('loggedIn')}</span>
          <div class="header-badge" data-i18n="headerBadge">${t('headerBadge')}</div>
        `;
      } else {
        bar.innerHTML = `
          ${langToggle}
          <div class="header-badge" data-i18n="headerBadge">${t('headerBadge')}</div>
        `;
      }
    }

    const BANNED_WORDS = [
      'è¦ç´„ã™ã‚‹ã¨', 'ã¾ã¨ã‚ã¨ã—ã¦', 'ç·ã˜ã¦',
      'ä¸€è€ƒã®ä¾¡å€¤ãŒã‚ã‚‹', 'æœ¬è¬›ç¾©ã¯', 'éå¸¸ã«é‡è¦', 'ç‰¹ç­†ã™ã¹ã'
    ];

    const LEVEL_MAP = {
      1: {
        pct: '10%',
        label: { ja: 'ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«', en: 'Basic' },
        desc: { ja: '10% â€” ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«', en: '10% â€” Basic' },
      },
      2: {
        pct: '30%',
        label: { ja: 'é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«', en: 'Casual' },
        desc: { ja: '30% â€” é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«', en: '30% â€” Casual' },
      },
      3: {
        pct: '50%',
        label: { ja: 'å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰', en: 'Standard' },
        desc: { ja: '50% â€” å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰', en: '50% â€” Standard' },
      },
      4: {
        pct: '70%',
        label: { ja: 'å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰', en: 'Advanced' },
        desc: { ja: '70% â€” å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰', en: '70% â€” Advanced' },
      },
      5: {
        pct: '90%',
        label: { ja: 'å¤§å­¦é™¢ãƒ»è«–æ–‡', en: 'Academic' },
        desc: { ja: '90% â€” å¤§å­¦é™¢ãƒ»è«–æ–‡ãƒ¬ãƒ™ãƒ«', en: '90% â€” Academic' },
      },
    };

    /* ============================================
       INIT
       ============================================ */
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('commentPaper_styleData');
      if (saved) {
        styleData = JSON.parse(saved);
        showStyleResults(styleData);
        showSavedBanner();
      }
      applyLanguage();   // i18n: apply saved/detected language
      initFileInput();

      // Drag & drop
      const uploadArea = document.getElementById('upload-area');
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 1 && userTier !== 'premium') {
          alert('ã‚¨ãƒ©ãƒ¼ï¼š1ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\n\nâ€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã‚“ã§è§£æã—ãŸã„å ´åˆã¯ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        if (files.length > 0) {
          processFile(files[0]);
        }
      });
    });

    /* ============================================
       STYLE ANALYSIS
       ============================================ */
    function analyzeStyle() {
      const text = document.getElementById('style-text').value.trim();
      if (!text || text.length < 20) {
        alert(currentLang === 'en'
          ? 'Please enter at least 20 characters to analyze.'
          : 'è§£æã™ã‚‹ã«ã¯20æ–‡å­—ä»¥ä¸Šã®æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (currentLang === 'en') {
        // ===== ENGLISH ANALYSIS =====
        const words = text.trim().split(/\s+/).filter(w => w.length > 0);
        const totalWordLen = words.reduce((a, w) => a + w.replace(/[^a-zA-Z]/g, '').length, 0);
        const avgWordLen = words.length > 0 ? (totalWordLen / words.length).toFixed(1) : 0;

        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
        const avgSentWords = sentences.length > 0
          ? Math.round(words.length / sentences.length)
          : 0;

        // Tone analysis
        const iMyCount = (text.match(/\b(I|my|me|myself)\b/gi) || []).length;
        const formalMarkers = (text.match(/\b(therefore|furthermore|moreover|consequently|nevertheless|hence|thus|whereas|nonetheless|notwithstanding)\b/gi) || []).length;
        const casualMarkers = (text.match(/\b(really|pretty|kind of|sort of|actually|basically|like|stuff|things|got|gonna|wanna)\b/gi) || []).length;

        let toneType = 'Neutral';
        if (formalMarkers >= 2 && casualMarkers === 0) toneType = 'Academic';
        else if (formalMarkers >= 1 && iMyCount <= 3) toneType = 'Semi-Formal';
        else if (casualMarkers >= 2 || iMyCount >= 5) toneType = 'Casual';
        else if (iMyCount >= 3) toneType = 'Personal';

        // Detected patterns
        const enConnectors = ['However,', 'Moreover,', 'Furthermore,', 'Therefore,',
          'In contrast,', 'Nevertheless,', 'For instance,', 'In addition,',
          'Consequently,', 'On the other hand,'];
        const foundConnectors = enConnectors.filter(c => text.includes(c));

        const freqExpressions = [];
        const enExprPatterns = [
          /\bhowever\b/gi, /\bmoreover\b/gi, /\bfurthermore\b/gi,
          /\btherefore\b/gi, /\bnevertheless\b/gi, /\bin addition\b/gi,
          /\bfor example\b/gi, /\bin contrast\b/gi, /\bas a result\b/gi,
          /\bin other words\b/gi
        ];
        enExprPatterns.forEach(p => {
          const m = text.match(p);
          if (m && m.length >= 1) freqExpressions.push(m[0]);
        });

        styleData = {
          kanjiRatio: avgWordLen,
          hiraganaRatio: 0,
          avgLength: avgSentWords,
          styleType: toneType,
          topEndings: foundConnectors,
          freqExpressions,
          sampleText: text.substring(0, 500),
          sentenceCount: sentences.length,
          lang: 'en',
        };

      } else {
        // ===== JAPANESE ANALYSIS =====
        // Kanji ratio
        const kanjiCount = (text.match(/[\u4E00-\u9FFF]/g) || []).length;
        const kanjiRatio = Math.round((kanjiCount / text.length) * 100);

        // Sentence analysis
        const sentences = text.split(/[ã€‚ï¼ï¼Ÿ\n]+/).filter(s => s.trim().length > 0);
        const avgLength = Math.round(sentences.reduce((a, s) => a + s.length, 0) / sentences.length);

        // Endings analysis
        const endings = {};
        const endingPatterns = [
          { pattern: /ã ã¨æ€ã†/, label: 'ã€œã ã¨æ€ã†' },
          { pattern: /ã¨æ€ã†/, label: 'ã€œã¨æ€ã†' },
          { pattern: /ã¨æ€ã£ãŸ/, label: 'ã€œã¨æ€ã£ãŸ' },
          { pattern: /ã¨æ„Ÿã˜ãŸ/, label: 'ã€œã¨æ„Ÿã˜ãŸ' },
          { pattern: /ã¨æ„Ÿã˜ã‚‹/, label: 'ã€œã¨æ„Ÿã˜ã‚‹' },
          { pattern: /ã§ã¯ãªã„ã ã‚ã†ã‹/, label: 'ã€œã§ã¯ãªã„ã ã‚ã†ã‹' },
          { pattern: /ã§ã¯ãªã„ã‹/, label: 'ã€œã§ã¯ãªã„ã‹' },
          { pattern: /ã§ã‚ã‚‹/, label: 'ã€œã§ã‚ã‚‹' },
          { pattern: /ã®ã /, label: 'ã€œã®ã ' },
          { pattern: /ã®ã§ã‚ã‚‹/, label: 'ã€œã®ã§ã‚ã‚‹' },
          { pattern: /ã ã£ãŸ/, label: 'ã€œã ã£ãŸ' },
          { pattern: /ã¾ã—ãŸ/, label: 'ã€œã¾ã—ãŸ' },
          { pattern: /ã§ã™/, label: 'ã€œã§ã™' },
          { pattern: /ã¾ã™/, label: 'ã€œã¾ã™' },
          { pattern: /ã ã¨è€ƒãˆã‚‹/, label: 'ã€œã ã¨è€ƒãˆã‚‹' },
          { pattern: /ãŸã„/, label: 'ã€œãŸã„' },
          { pattern: /ã‹ã‚‚ã—ã‚Œãªã„/, label: 'ã€œã‹ã‚‚ã—ã‚Œãªã„' },
          { pattern: /ã¨è¨€ãˆã‚‹/, label: 'ã€œã¨è¨€ãˆã‚‹' },
        ];

        sentences.forEach(s => {
          const trimmed = s.trim();
          endingPatterns.forEach(ep => {
            if (ep.pattern.test(trimmed)) {
              endings[ep.label] = (endings[ep.label] || 0) + 1;
            }
          });
        });

        const topEndings = Object.entries(endings)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(e => e[0]);

        // Determine style type
        const hasDa = topEndings.some(e => e.includes('ã§ã‚ã‚‹') || e.includes('ã®ã '));
        const hasDesu = topEndings.some(e => e.includes('ã§ã™') || e.includes('ã¾ã™'));
        let styleType = 'æ··åœ¨å‹';
        if (hasDa && !hasDesu) styleType = 'ã ãƒ»ã§ã‚ã‚‹èª¿';
        else if (hasDesu && !hasDa) styleType = 'ã§ã™ãƒ»ã¾ã™èª¿';

        // Frequent expressions
        const freqExpressions = [];
        const exprPatterns = [
          /ã—ã‹ã—/g, /ä¸€æ–¹ã§/g, /ã¾ãŸ/g, /ãã®ãŸã‚/g, /ã¤ã¾ã‚Š/g,
          /ä¾‹ãˆã°/g, /ãªãœãªã‚‰/g, /ãã‚Œã‚†ãˆ/g, /ã™ãªã‚ã¡/g,
          /ç¢ºã‹ã«/g, /ã‚€ã—ã‚/g, /ãŸã ã—/g, /ç‰¹ã«/g, /å®Ÿéš›ã«/g
        ];
        exprPatterns.forEach(p => {
          const m = text.match(p);
          if (m && m.length >= 1) {
            freqExpressions.push(p.source);
          }
        });

        // Hiragana ratio
        const hiraganaCount = (text.match(/[\u3040-\u309F]/g) || []).length;
        const hiraganaRatio = Math.round((hiraganaCount / text.length) * 100);

        const kanjiRatioVal = kanjiRatio;

        styleData = {
          kanjiRatio: kanjiRatioVal,
          hiraganaRatio,
          avgLength,
          styleType,
          topEndings,
          freqExpressions,
          sampleText: text.substring(0, 500),
          sentenceCount: sentences.length,
          lang: 'ja',
        };

        // è‡ªå‹•ãƒ¬ãƒ™ãƒ«åˆ¤å®š & ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åŒæœŸ
        analyzeVocabularyLevel(text, kanjiRatioVal, avgLength, freqExpressions);
      }

      localStorage.setItem('commentPaper_styleData', JSON.stringify(styleData));
      showStyleResults(styleData);
      showSavedBanner();

      // ============ å­¦ç¿’å±¥æ­´ã®è“„ç© ============
      saveStyleHistory(text);
    }

    function showStyleResults(data) {
      const displayLang = currentLang || 'ja';
      const tr = translations[displayLang];

      // Values â€” data.lang ã¯åˆ†ææ™‚ã®è¨€èªã€displayLang ã¯ç¾åœ¨ã®UIè¨€èª
      if (data.lang === 'en') {
        // ENåˆ†æãƒ‡ãƒ¼ã‚¿: kanjiRatio=avgWordLen, avgLength=avgSentWords
        document.getElementById('stat-kanji').textContent = data.kanjiRatio;
        document.getElementById('stat-avg-len').textContent = data.avgLength + ' ' + tr.unit;
      } else {
        // JAåˆ†æãƒ‡ãƒ¼ã‚¿: kanjiRatio=æ¼¢å­—ç‡%, avgLength=å¹³å‡æ–‡å­—æ•°
        document.getElementById('stat-kanji').textContent = data.kanjiRatio + '%';
        document.getElementById('stat-avg-len').textContent = data.avgLength + tr.unit;
      }
      document.getElementById('stat-endings').textContent = tr.styleTypeMap[data.styleType] || data.styleType;

      // Labels
      const kanjiLabel = document.querySelector('#style-stats .stat-item:nth-child(1) .stat-label');
      const lenLabel = document.querySelector('#style-stats .stat-item:nth-child(2) .stat-label');
      const endLabel = document.querySelector('#style-stats .stat-item:nth-child(3) .stat-label');
      if (kanjiLabel) kanjiLabel.textContent = tr.kanji;
      if (lenLabel) lenLabel.textContent = tr.length;
      if (endLabel) endLabel.textContent = tr.endings;

      // Patterns
      const patternsEl = document.getElementById('style-patterns');
      const sep = tr.separator;
      let patternsHTML = '<strong>' + tr.patterns + '</strong> ' + (data.topEndings.join(sep) || tr.none);
      if (data.freqExpressions.length > 0) {
        patternsHTML += '<br><strong>' + tr.freqLabel + '</strong> ' + data.freqExpressions.join(sep);
      }
      patternsEl.innerHTML = patternsHTML;

      document.getElementById('style-stats').classList.add('show');
      document.getElementById('style-patterns').classList.add('show');
      document.getElementById('reset-style-btn').classList.add('show');
    }

    /** è¨€èªåˆ‡æ›¿æ™‚ã«ãƒ©ãƒ™ãƒ«ãƒ»å˜ä½ã‚’å‹•çš„ã«æ›´æ–°ï¼ˆå€¤ã¯å†è¨ˆç®—ã—ãªã„ï¼‰ */
    function syncStyleLabels() {
      const tr = translations[currentLang] || translations.ja;
      // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      const kanjiLabel = document.querySelector('#style-stats .stat-item:nth-child(1) .stat-label');
      const lenLabel = document.querySelector('#style-stats .stat-item:nth-child(2) .stat-label');
      const endLabel = document.querySelector('#style-stats .stat-item:nth-child(3) .stat-label');
      if (kanjiLabel) kanjiLabel.textContent = tr.kanji;
      if (lenLabel) lenLabel.textContent = tr.length;
      if (endLabel) endLabel.textContent = tr.endings;

      // æ—¢å­˜ã®åˆ†æçµæœãŒã‚ã‚Œã°ã€å€¤ã®å˜ä½ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã‚‚æ›´æ–°
      if (styleData) {
        showStyleResults(styleData);
      }
    }

    function showSavedBanner() {
      document.getElementById('style-banner').classList.add('show');
    }

    function resetStyle() {
      if (!confirm('æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem('commentPaper_styleData');
      styleData = null;
      document.getElementById('style-banner').classList.remove('show');
      document.getElementById('style-stats').classList.remove('show');
      document.getElementById('style-patterns').classList.remove('show');
      document.getElementById('reset-style-btn').classList.remove('show');
      document.getElementById('style-text').value = '';
    }

    /* ============================================
       AIè‡ªå‹•ãƒ¬ãƒ™ãƒ«åˆ¤åˆ¥ãƒ­ã‚¸ãƒƒã‚¯
       ============================================ */
    const LEVEL_LABELS = {
      1: 'å…±æ„Ÿå‹ãƒ“ã‚®ãƒŠãƒ¼',
      2: 'é«˜æ ¡ç”Ÿ',
      3: 'å¤§å­¦ç”Ÿæ¨™æº–',
      4: 'å„ªç­‰ç”Ÿ',
      5: 'ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯',
    };

    function analyzeVocabularyLevel(text, kanjiRatio, avgSentLen, freqExprs) {
      let score = 0;

      // 1. æ¼¢å­—ç‡ã‚¹ã‚³ã‚¢ (0ã€œ25ç‚¹)
      if (kanjiRatio >= 35) score += 25;
      else if (kanjiRatio >= 28) score += 20;
      else if (kanjiRatio >= 22) score += 15;
      else if (kanjiRatio >= 15) score += 10;
      else score += 5;

      // 2. å¹³å‡æ–‡é•·ã‚¹ã‚³ã‚¢ (0ã€œ25ç‚¹)
      if (avgSentLen >= 60) score += 25;
      else if (avgSentLen >= 45) score += 20;
      else if (avgSentLen >= 35) score += 15;
      else if (avgSentLen >= 25) score += 10;
      else score += 5;

      // 3. å­¦è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ (0ã€œ30ç‚¹)
      const academicKeywords = [
        /åˆ†æ/g, /å®šç¾©/g, /ç†è«–/g, /èƒŒæ™¯/g, /è€ƒå¯Ÿ/g, /è­°è«–/g,
        /æ çµ„ã¿/g, /æ–¹æ³•è«–/g, /å¦¥å½“æ€§/g, /ä¿¡é ¼æ€§/g, /ä»®èª¬/g,
        /æ¦‚å¿µ/g, /æ§‹é€ /g, /å‰æ/g, /å…ˆè¡Œç ”ç©¶/g, /å®Ÿè¨¼/g,
        /æ‰¹åˆ¤çš„/g, /ä½“ç³»çš„/g, /èªè­˜è«–/g, /ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ /g,
        /æ¤œè¨¼/g, /æ¨è«–/g, /å¤‰æ•°/g, /å°ºåº¦/g, /å› å­/g,
      ];
      let kwCount = 0;
      academicKeywords.forEach(kw => {
        const m = text.match(kw);
        if (m) kwCount += m.length;
      });
      if (kwCount >= 10) score += 30;
      else if (kwCount >= 6) score += 24;
      else if (kwCount >= 3) score += 16;
      else if (kwCount >= 1) score += 8;
      else score += 2;

      // 4. ç¡¬ã„æ¥ç¶šè©ã‚¹ã‚³ã‚¢ (0ã€œ20ç‚¹)
      const formalConnectors = [
        /ã™ãªã‚ã¡/g, /æ›è¨€ã™ã‚Œã°/g, /ãã‚Œã‚†ãˆ/g, /ç¿»ã£ã¦/g,
        /ã‚‚ã£ã¨ã‚‚/g, /ç•¢ç«Ÿ/g, /ã¨ã‚Šã‚ã‘/g, /çœ‹å–/g,
        /ç­‰é–‘è¦–/g, /é½Ÿé½¬/g, /å°„ç¨‹/g,
      ];
      let formalCount = 0;
      formalConnectors.forEach(fc => {
        const m = text.match(fc);
        if (m) formalCount += m.length;
      });
      score += Math.min(formalCount * 5, 20);

      // ã‚¹ã‚³ã‚¢ â†’ ãƒ¬ãƒ™ãƒ«å¤‰æ› (0-100 â†’ 1-5)
      let level;
      if (score >= 75) level = 5;
      else if (score >= 55) level = 4;
      else if (score >= 38) level = 3;
      else if (score >= 22) level = 2;
      else level = 1;

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å³åº§ã«åŒæœŸ
      setSlider(level);

      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
      const label = LEVEL_LABELS[level];
      showToast(`ğŸ” èªå½™ãƒ¬ãƒ™ãƒ«åˆ¤å®šï¼šLevel ${level}ï¼ˆ${label}ï¼‰â€” ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è‡ªå‹•èª¿æ•´ã—ã¾ã—ãŸ`);

      return level;
    }

    function showToast(message, duration = 4000) {
      // æ—¢å­˜ã®toastãŒã‚ã‚Œã°å‰Šé™¤
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      // è‡ªå‹•æ¶ˆå»
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
      }, duration);
    }

    /* ============================================
       FILE HANDLING (PDF / Word / PPT)
       ============================================ */
    function initFileInput() {
      const fileInput = document.getElementById('file-input');
      if (userTier === 'premium') {
        fileInput.setAttribute('multiple', '');
      } else {
        fileInput.removeAttribute('multiple');
      }
    }

    function handleFileUpload(event) {
      const files = event.target.files;
      if (files.length > 1 && userTier !== 'premium') {
        alert('ã‚¨ãƒ©ãƒ¼ï¼š1ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\n\nâ€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã‚“ã§è§£æã—ãŸã„å ´åˆã¯ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        event.target.value = '';
        return;
      }
      if (files[0]) processFile(files[0]);
    }

    async function processFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      const supported = ['pdf', 'docx', 'pptx'];
      if (!supported.includes(ext)) {
        alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚PDF, Word (.docx), PowerPoint (.pptx) ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }

      // Show file name & loading
      document.getElementById('file-name-text').textContent = file.name;
      document.getElementById('file-name-display').classList.add('show');
      document.getElementById('file-loading').classList.add('show');

      try {
        let fullText = '';
        const arrayBuffer = await file.arrayBuffer();

        if (ext === 'pdf') {
          fullText = await extractPDF(arrayBuffer);
        } else if (ext === 'docx') {
          fullText = await extractWord(arrayBuffer);
        } else if (ext === 'pptx') {
          fullText = await extractPPTX(arrayBuffer);
        }

        document.getElementById('resume-text').value = fullText.trim();
      } catch (err) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      } finally {
        document.getElementById('file-loading').classList.remove('show');
      }
    }

    async function extractPDF(arrayBuffer) {
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + '\n';
      }
      return fullText;
    }

    async function extractWord(arrayBuffer) {
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      return result.value;
    }

    async function extractPPTX(arrayBuffer) {
      const zip = await JSZip.loadAsync(arrayBuffer);
      let allText = '';
      // Iterate through slide XML files
      const slideFiles = Object.keys(zip.files)
        .filter(name => /^ppt\/slides\/slide\d+\.xml$/.test(name))
        .sort((a, b) => {
          const numA = parseInt(a.match(/slide(\d+)/)[1]);
          const numB = parseInt(b.match(/slide(\d+)/)[1]);
          return numA - numB;
        });

      for (const slidePath of slideFiles) {
        const xmlStr = await zip.files[slidePath].async('string');
        // Parse XML and extract text nodes (<a:t> tags)
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlStr, 'application/xml');
        const textNodes = xmlDoc.getElementsByTagNameNS('http://schemas.openxmlformats.org/drawingml/2006/main', 't');
        const slideTexts = [];
        for (let i = 0; i < textNodes.length; i++) {
          const t = textNodes[i].textContent.trim();
          if (t) slideTexts.push(t);
        }
        if (slideTexts.length > 0) {
          allText += slideTexts.join(' ') + '\n';
        }
      }
      return allText;
    }

    /* ============================================
       SLIDER
       ============================================ */
    function updateSlider(val) {
      val = parseInt(val);
      const lang = currentLang || 'ja';
      document.getElementById('level-badge').textContent = LEVEL_MAP[val].desc[lang] || LEVEL_MAP[val].desc.ja;

      document.querySelectorAll('.slider-label').forEach((el, i) => {
        el.classList.toggle('active', i === val - 1);
      });
    }

    function setSlider(val) {
      document.getElementById('quality-slider').value = val;
      updateSlider(val);
    }

    /* ============================================
       GENERATION LOGIC
       ============================================ */
    function generatePaper() {
      const lectureName = document.getElementById('lecture-name').value.trim();
      const resumeText = document.getElementById('resume-text').value.trim();

      const level = parseInt(document.getElementById('quality-slider').value);
      const dept = document.getElementById('dept-filter').value;

      // Show result section with loading
      const resultSection = document.getElementById('result-section');
      document.getElementById('result-empty').style.display = 'none';
      document.getElementById('loading').classList.add('show');
      document.getElementById('result-content').classList.add('hidden');
      document.getElementById('copy-feedback').classList.remove('show');

      // Scroll to result
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Simulate generation delay
      setTimeout(() => {
        const generated = buildCommentPaper(lectureName, resumeText, level, dept);
        document.getElementById('result-text').textContent = generated;
        document.getElementById('loading').classList.remove('show');
        document.getElementById('result-content').classList.remove('hidden');
      }, 1500);
    }

    function buildCommentPaper(lecture, resume, level, dept) {
      // Extract keywords from resume
      const keywords = extractKeywords(resume);
      const mainTopic = keywords[0] || lecture;
      const subTopic = keywords[1] || '';

      // Determine style parameters
      const ending = getEndingStyle();
      const connector = getConnectors(level);

      let output = '';

      switch (level) {
        case 1: // 10% - ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«
          output = generate10(lecture, mainTopic, subTopic, ending, keywords);
          break;
        case 2: // 30% - é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«
          output = generate30(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 3: // 50% - å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰
          output = generate50(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 4: // 70% - å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰
          output = generate70(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 5: // 90% - å¤§å­¦é™¢ãƒ»è«–æ–‡ãƒ¬ãƒ™ãƒ«
          output = generate90(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
      }

      // å­¦ç¿’å±¥æ­´ã‹ã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ³¨å…¥
      output = injectHistoryPatterns(output, level);

      // --- [DATA FLYWHEEL] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŠ½å‡º & ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ¼ãƒ«é€ä¿¡ ---
      const globalTemplate = extractGlobalTemplates(resume);
      submitToGlobalPool(globalTemplate);
      // --- [/DATA FLYWHEEL] ---

      // Apply department tone
      output = applyDeptTone(output, dept);

      // Remove banned words
      BANNED_WORDS.forEach(w => {
        output = output.replaceAll(w, '');
      });

      // Clean up double spaces and line breaks
      output = output.replace(/\n{3,}/g, '\n\n').trim();

      // --- [LENGTH CONTROL] æŒ‡å®šæ–‡å­—æ•°ï¼æœ€ä½ä¿è¨¼ã€ä¸Šé™110%ã§å‡ºåŠ› ---
      output = adjustToTargetLength(output, level, lecture, mainTopic, subTopic, ending, keywords);

      return output;
    }

    /**
     * adjustToTargetLength â€” å³æ ¼ãªæ–‡å­—æ•°åˆ¶å¾¡
     *
     * ã€ãƒ«ãƒ¼ãƒ«ã€‘
     *  - ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ ï¼ æœ€ä½æ–‡å­—æ•°ï¼ˆ1æ–‡å­—ã§ã‚‚ä¸‹å›ã‚‹ã“ã¨ã¯è¨±ã•ã‚Œãªã„ï¼‰
     *  - ä¸Šé™ ï¼ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã®110%
     *  - ä¾‹: 400 â†’ 400ã€œ440å­—ã®ç¯„å›²ã§å¿…ãšå‡ºåŠ›
     *  - ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢ï¼šæé€ ã•ã‚ŒãŸäº‹å®Ÿã‚„æ–‡çŒ®ã¯è¿½åŠ ã—ãªã„
     */
    function adjustToTargetLength(text, level, lecture, main, sub, ending, kw) {
      const targetLength = parseInt(document.getElementById('length-slider').value);
      const countMode = document.getElementById('count-mode').value;
      const minLen = targetLength;                         // æœ€ä½ä¿è¨¼ï¼ˆä¸‹å›ã‚Šç¦æ­¢ï¼‰
      const maxLen = Math.ceil(targetLength * 1.10);       // ä¸Šé™110%

      const activeLang = getActiveLang();
      const pool = activeLang[`level${level}`];
      const conn = getConnectors(level);

      // ===== Phase 1: ä¸Šé™è¶…é â†’ æ–‡å˜ä½ã§ãƒˆãƒªãƒŸãƒ³ã‚° =====
      let currentLen = countText(text, countMode);
      if (currentLen > maxLen) {
        const sep = currentLang === 'en' ? '. ' : 'ã€‚';
        const sentences = text.split(sep).filter(s => s.trim());
        let trimmed = '';
        for (const s of sentences) {
          const candidate = trimmed + s + sep;
          if (countText(candidate, countMode) > maxLen && trimmed.length > 0) break;
          trimmed = candidate;
        }
        text = trimmed.trim();
      }

      // ===== Phase 2: ä¸‹é™ä¸è¶³ â†’ ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ—ãƒ¼ãƒ«ã‹ã‚‰å®‰å…¨ã«è£œå…… =====
      currentLen = countText(text, countMode);
      if (currentLen < minLen && pool) {

        // 2-a: bodies ã‹ã‚‰æœ¬è«–æ–‡ã‚’è¿½åŠ ï¼ˆæœ€å¤§5å›ï¼‰
        if (pool.bodies) {
          let attempts = 0;
          while (countText(text, countMode) < minLen && attempts < 5) {
            const c = conn ? pickRandom(conn) : '';
            const extraFn = pickRandom(pool.bodies);
            const extra = extraFn(main, sub || kw[1] || '');
            text = text + (c ? c + 'ã€' : '') + extra;
            attempts++;
          }
        }

        // 2-b: ã¾ã è¶³ã‚Šãªã‘ã‚Œã° reflections ã‚’è¿½åŠ 
        currentLen = countText(text, countMode);
        if (currentLen < minLen && pool.reflections) {
          const reflection = pickRandom(pool.reflections);
          text = text + reflection;
        }

        // 2-c: ãã‚Œã§ã‚‚è¶³ã‚Šãªã‘ã‚Œã° closings ã‚’è¿½åŠ 
        currentLen = countText(text, countMode);
        if (currentLen < minLen && pool.closings) {
          const closingFn = pickRandom(pool.closings);
          text = text + closingFn(lecture);
        }
      }

      // ===== Phase 3: å¾®èª¿æ•´ â€” å†åº¦ã®ä¸Šé™è¶…éã‚’æ–‡å˜ä½ã§ã‚«ãƒƒãƒˆ =====
      currentLen = countText(text, countMode);
      if (currentLen > maxLen) {
        const sep = currentLang === 'en' ? '. ' : 'ã€‚';
        const sentences = text.split(sep).filter(s => s.trim());
        let trimmed = '';
        for (const s of sentences) {
          const candidate = trimmed + s + sep;
          if (countText(candidate, countMode) > maxLen && trimmed.length > 0) break;
          trimmed = candidate;
        }
        text = trimmed.trim();
        // æ–‡å˜ä½ãƒˆãƒªãƒ ã§ä¸‹é™ã‚’å‰²ã£ãŸå ´åˆã¯å¼·åˆ¶çš„ã«æœ€å¾Œã®æ–‡ã‚’æˆ»ã™
        if (countText(text, countMode) < minLen && sentences.length > 0) {
          text = sentences.join(sep) + sep;
          // ä¸Šé™è¶…éã—ã¦ã‚‚ä¸‹é™ã‚’å„ªå…ˆ
        }
      }

      // ===== Phase 4: æœ€çµ‚ãƒãƒ¼ãƒ‰ã‚«ãƒƒãƒˆï¼ˆä¸Šé™ã®å³å®ˆãŒä¸‹é™ã‚ˆã‚ŠåŠ£å¾Œï¼‰ =====
      // ä¸‹é™ã¯çµ¶å¯¾ã«æ­»å®ˆã€‚ä¸Šé™ã¯å¯èƒ½ãªé™ã‚Šå®ˆã‚‹ãŒã€ä¸‹é™å„ªå…ˆã€‚
      currentLen = countText(text, countMode);
      if (currentLen > maxLen && currentLang !== 'en') {
        // ä¸Šé™è¿‘ãã®å¥ç‚¹ã§ã‚«ãƒƒãƒˆ
        const cutPos = maxLen;
        const snippet = text.substring(0, cutPos);
        const lastPeriod = snippet.lastIndexOf('ã€‚');
        if (lastPeriod > minLen) {
          text = text.substring(0, lastPeriod + 1);
        }
      }

      return text;
    }

    function extractKeywords(text) {
      // Japanese text has no natural word boundaries, so we use pattern matching
      // to extract noun-like compound phrases

      const freq = {};

      // 1. Extract katakana compound words (e.g. ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢, ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ«, ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
      const katakanaMatches = text.match(/[\u30A1-\u30F6ãƒ¼]{3,}/g) || [];
      katakanaMatches.forEach(w => { freq[w] = (freq[w] || 0) + 1; });

      // 2. Extract kanji compound words (e.g. å…¬å…±åœ, æƒ…å ±é¸åˆ¥, æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼)
      const kanjiMatches = text.match(/[\u4E00-\u9FFF]{2,6}/g) || [];
      const kanjiStopWords = new Set([
        'æœ¬è¬›ç¾©', 'å—è¬›è€…', 'è€ƒå¯Ÿ', 'è­°è«–', 'ç›®æŒ‡', 'å¤‰åŒ–', 'è‡ªèº«',
        'æ‰¹åˆ¤çš„', 'ç‰¹ã«', 'è¬›ç¾©', 'å½¢æ…‹', 'æŒ¯ã‚Šè¿”', 'ä»¥ä¸‹', 'ä¸Šè¨˜',
        'å ´åˆ', 'å¿…è¦', 'é‡è¦', 'ç†è§£', 'å­¦ç¿’', 'å‘ä¸Š', 'åˆ©ç”¨'
      ]);
      kanjiMatches.forEach(w => {
        if (kanjiStopWords.has(w)) return;
        freq[w] = (freq[w] || 0) + 1;
      });

      // 3. Extract mixed kanji+katakana/hiragana noun phrases
      //    e.g. "æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼", "ãƒ¡ãƒ‡ã‚£ã‚¢åˆ©ç”¨", "å…¬å…±åœã®å¤‰å®¹"
      const mixedPatterns = [
        /[\u4E00-\u9FFF]{1,4}[\u30A1-\u30F6ãƒ¼]{2,}/g,     // kanji+katakana
        /[\u30A1-\u30F6ãƒ¼]{2,}[\u4E00-\u9FFF]{1,4}/g,     // katakana+kanji
        /([\u4E00-\u9FFF\u30A1-\u30F6ãƒ¼]{2,})ã®([\u4E00-\u9FFF\u30A1-\u30F6ãƒ¼]{2,})/g  // Xã® Y patterns
      ];
      mixedPatterns.forEach(pat => {
        let match;
        const regex = new RegExp(pat.source, pat.flags);
        while ((match = regex.exec(text)) !== null) {
          const phrase = match[0];
          if (phrase.length >= 3 && phrase.length <= 15) {
            freq[phrase] = (freq[phrase] || 0) + 1;
          }
        }
      });

      // Exclude banned-like terms and very generic words
      const excludeTerms = new Set([
        'æœ¬è¬›ç¾©', 'å—è¬›è€…', 'è¬›ç¾©ã§ã¯', 'æœ¬è¬›ç¾©ã§ã¯', 'ã«ã¤ã„ã¦', 'ã«ãŠã‘ã‚‹'
      ]);

      return Object.entries(freq)
        .filter(([k]) => !excludeTerms.has(k) && k.length >= 2)
        .sort((a, b) => {
          // Prefer longer, more specific terms, then by frequency
          const lenDiff = Math.min(b[0].length, 8) - Math.min(a[0].length, 8);
          if (lenDiff !== 0) return lenDiff;
          return b[1] - a[1];
        })
        .slice(0, 8)
        .map(e => e[0]);
    }

    function getEndingStyle() {
      if (styleData) {
        if (styleData.styleType === 'ã ãƒ»ã§ã‚ã‚‹èª¿') return 'da';
        if (styleData.styleType === 'ã§ã™ãƒ»ã¾ã™èª¿') return 'desu';
        return 'mixed';
      }
      return 'desu'; // default
    }

    /* ============================================
       STYLE HISTORY â€” å­¦ç¿’å±¥æ­´ã®ä¿å­˜ã¨æ³¨å…¥
       ============================================ */
    function getStyleHistory() {
      try {
        return JSON.parse(localStorage.getItem('ac_styleHistory') || '[]');
      } catch { return []; }
    }

    function saveStyleHistory(text) {
      const maxFree = 3;
      const maxPremium = 30;
      const limit = userTier === 'premium' ? maxPremium : maxFree;

      let history = getStyleHistory();

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜æ–‡ç« ã¯ä¿å­˜ã—ãªã„ï¼‰
      const snippet = text.substring(0, 200);
      if (history.some(h => h.substring(0, 200) === snippet)) {
        showToast('ğŸ“ ã“ã®æ–‡ç« ã¯æ—¢ã«å­¦ç¿’æ¸ˆã¿ã§ã™');
        return;
      }

      history.push(text);

      // ä¸Šé™è¶…éæ™‚ã«å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
      while (history.length > limit) {
        history.shift();
      }

      localStorage.setItem('ac_styleHistory', JSON.stringify(history));

      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
      const count = history.length;
      if (userTier !== 'premium' && count >= maxFree) {
        showToast(`ğŸ“š æ–‡ä½“å­¦ç¿’ï¼š${count}/${maxFree}ä»¶ï¼ˆä¸Šé™ï¼‰\nâ€»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã§${maxPremium}ä»¶ã¾ã§è¨˜æ†¶ã‚’æ‹¡å¼µã§ãã¾ã™`, 5000);
      } else {
        showToast(`ğŸ“š æ–‡ä½“å­¦ç¿’ï¼š${count}/${limit}ä»¶ã‚’è¨˜æ†¶ã—ã¾ã—ãŸ`);
      }
    }

    function injectHistoryPatterns(output, level) {
      const history = getStyleHistory();
      if (history.length === 0) return output;

      // å±¥æ­´ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆã—ã¦é »å‡ºè¡¨ç¾ã‚’æŠ½å‡º
      const combined = history.join('');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
      const userPatterns = [];

      // 1. æ–‡æœ«è¡¨ç¾ã®ç™–
      const endingHabits = [
        { pattern: /ã®ã§ã¯ãªã„ã ã‚ã†ã‹/g, text: 'ã®ã§ã¯ãªã„ã ã‚ã†ã‹' },
        { pattern: /ã¨è€ƒãˆã‚‹/g, text: 'ã¨è€ƒãˆã‚‹' },
        { pattern: /ã¨æ„Ÿã˜ãŸ/g, text: 'ã¨æ„Ÿã˜ãŸ' },
        { pattern: /ã‚ˆã†ã«æ€ã†/g, text: 'ã‚ˆã†ã«æ€ã†' },
        { pattern: /æ°—ãŒã™ã‚‹/g, text: 'æ°—ãŒã™ã‚‹' },
        { pattern: /ã¹ãã§ã‚ã‚‹/g, text: 'ã¹ãã§ã‚ã‚‹' },
        { pattern: /ã«ã»ã‹ãªã‚‰ãªã„/g, text: 'ã«ã»ã‹ãªã‚‰ãªã„' },
        { pattern: /ã¨è¨€ãˆã‚ˆã†/g, text: 'ã¨è¨€ãˆã‚ˆã†' },
        { pattern: /ã“ã¨ãŒé‡è¦ã /g, text: 'ã“ã¨ãŒé‡è¦ã ' },
        { pattern: /å¿…è¦ãŒã‚ã‚‹/g, text: 'å¿…è¦ãŒã‚ã‚‹' },
      ];

      endingHabits.forEach(eh => {
        const m = combined.match(eh.pattern);
        if (m && m.length >= 2) {
          userPatterns.push(eh.text);
        }
      });

      // 2. æ¥ç¶šè¡¨ç¾ã®ç™–
      const connHabits = [
        { pattern: /ç¢ºã‹ã«/g, text: 'ç¢ºã‹ã«' },
        { pattern: /ãã‚‚ãã‚‚/g, text: 'ãã‚‚ãã‚‚' },
        { pattern: /ã„ãšã‚Œã«ã›ã‚ˆ/g, text: 'ã„ãšã‚Œã«ã›ã‚ˆ' },
        { pattern: /ç‡ç›´ã«è¨€ãˆã°/g, text: 'ç‡ç›´ã«è¨€ãˆã°' },
        { pattern: /å€‹äººçš„ã«ã¯/g, text: 'å€‹äººçš„ã«ã¯' },
        { pattern: /æ­£ç›´ãªã¨ã“ã‚/g, text: 'æ­£ç›´ãªã¨ã“ã‚' },
      ];

      connHabits.forEach(ch => {
        const m = combined.match(ch.pattern);
        if (m && m.length >= 1) {
          userPatterns.push(ch.text);
        }
      });

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‡ºåŠ›ã«ç¹”ã‚Šè¾¼ã‚€
      if (userPatterns.length > 0) {
        const sentences = output.split('ã€‚').filter(s => s.trim());
        if (sentences.length >= 3) {
          // æ–‡ä¸­ã®1ç®‡æ‰€ã«ç™–ã‚’æ³¨å…¥ï¼ˆè‡ªç„¶ã«è¦‹ãˆã‚‹ã‚ˆã†ä¸­ç›¤ã«æŒ¿å…¥ï¼‰
          const insertIdx = Math.floor(sentences.length / 2);
          const habit = pickRandom(userPatterns);

          // æ¥ç¶šè¡¨ç¾ã®å ´åˆã¯æ–‡é ­ã«è¿½åŠ 
          if (['ç¢ºã‹ã«', 'ãã‚‚ãã‚‚', 'ã„ãšã‚Œã«ã›ã‚ˆ', 'ç‡ç›´ã«è¨€ãˆã°', 'å€‹äººçš„ã«ã¯', 'æ­£ç›´ãªã¨ã“ã‚'].includes(habit)) {
            sentences[insertIdx] = habit + 'ã€' + sentences[insertIdx].trim();
          }
          // æ–‡æœ«è¡¨ç¾ã®å ´åˆã¯æœ«å°¾ã‚’å·®ã—æ›¿ãˆ
          else if (sentences[insertIdx].length > 10) {
            // æœ€å¾Œã®å¥èª­ç‚¹å‰ã®è¡¨ç¾ã‚’ç½®æ›å€™è£œã«ã™ã‚‹
            const s = sentences[insertIdx].trim();
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–‡æœ«ç™–ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ 
            if (level >= 3 && Math.random() > 0.5) {
              sentences.splice(insertIdx + 1, 0, `ã“ã®ç‚¹ã¯${habit}`);
            }
          }
          output = sentences.join('ã€‚') + 'ã€‚';
          // äºŒé‡å¥èª­ç‚¹ã®ä¿®æ­£
          output = output.replace(/ã€‚ã€‚/g, 'ã€‚');
        }
      }

      return output;
    }

    /* ============================================
       GLOBAL DATA FLYWHEEL â€” é›†åˆçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŸºç›¤ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
       ============================================ */

    /** ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®éª¨çµ„ã¿ã‚’æŠ½å‡ºã™ã‚‹ */
    function extractGlobalTemplates(text) {
      if (!text) return "";
      let template = text;

      // 1. URL ã‚’å…ˆã«ãƒã‚¹ã‚­ãƒ³ã‚°ï¼ˆå€‹äººæƒ…å ±ä¿è­· & æé€ å¯¾ç­–ï¼‰
      template = template.replace(/https?:\/\/[^\sã€ã€ï¼‰ã€‘>]+/g, "[URL]");

      // 2. ã‚«ã‚®æ‹¬å¼§ãªã©ã®å¼•ç”¨éƒ¨åˆ†ã‚’ãƒã‚¹ã‚­ãƒ³ã‚°ï¼ˆä½œå“åã€è«–æ–‡åã€å›ºæœ‰åè©ã®ä¿è­·ï¼‰
      template = template.replace(/[ã€Œã€ï¼ˆã€<](.*?)[ã€ã€ï¼‰ã€‘>]/g, "ã€Œ[å›ºæœ‰æ¦‚å¿µ]ã€");

      // 3. è‹±å˜èªã‚’ãƒã‚¹ã‚­ãƒ³ã‚°ï¼ˆæé€ å¯¾ç­–ï¼‰â€” ã™ã§ã« [] ã§å›²ã¾ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯é™¤å¤–
      template = template.replace(/(?<!\[)[a-zA-Z]+(?!\w*\])/g, "[ENG]");

      // 4. æ•°å­—ãƒ»å¹´ä»£ãƒ»ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’ãƒã‚¹ã‚­ãƒ³ã‚°
      template = template.replace(/(?<!\[)\d+(\.\d+)?(?!\])/g, "[NUM]");

      return template;
    }

    /** æŠ½å‡ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å…±æœ‰ãƒ—ãƒ¼ãƒ«ã¸é€ä¿¡ã™ã‚‹ãƒ¢ãƒƒã‚¯ */
    function submitToGlobalPool(template) {
      // ãƒ¢ãƒƒã‚¯: æœ¬ç•ªç’°å¢ƒã§ã¯ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸é€ä¿¡
    }

    function e(type, variations) {
      // Return ending based on style type
      const v = variations[type] || variations['desu'];
      return Array.isArray(v) ? v[Math.floor(Math.random() * v.length)] : v;
    }

    function getConnectors(level) {
      const pool = getActiveLang();
      const conn = pool.connectors || LANG.ja.connectors;
      if (level <= 2) return conn.casual;
      if (level <= 3) return conn.standard;
      return conn.formal;
    }

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function pickMultiple(arr, n) {
      const shuffled = [...arr].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(n, shuffled.length));
    }

    /* ============================================
       UNIFIED PHRASE-POOL GENERATOR
       ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ—ãƒ¼ãƒ«é§†å‹•ã®çµ±åˆç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³
       ============================================ */
    function generateFromPool(lecture, main, sub, ending, level, kw) {
      const activeLang = getActiveLang();
      const pool = activeLang[`level${level}`];
      if (!pool) return currentLang === 'en'
        ? `In ${lecture}, we learned about ${main}.`
        : `${lecture}ã§${main}ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚`;

      const conn = getConnectors(level);

      // 1. Opener â€” ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ—ãƒ¼ãƒ«ã‹ã‚‰é¸æŠ
      const openerFn = pickRandom(pool.openers);
      let opener = openerFn(lecture, main);

      // 2. Body â€” æœ¬è«–å±•é–‹ï¼ˆ2ã€œ3æ–‡é¸æŠï¼‰
      const bodyCount = level <= 2 ? 2 : level <= 4 ? 2 : 3;
      const bodyFns = pickMultiple(pool.bodies, bodyCount);
      let bodyTexts = bodyFns.map(fn => fn(main, sub || kw[1] || ''));

      // æ¥ç¶šè©ã‚’æœ¬è«–é–“ã«æŒ¿å…¥
      if (bodyTexts.length > 1) {
        for (let i = 1; i < bodyTexts.length; i++) {
          bodyTexts[i] = pickRandom(conn) + 'ã€' + bodyTexts[i];
        }
      }

      // 3. Reflection â€” å€‹äººçš„æ„Ÿæƒ³
      const reflection = pickRandom(pool.reflections);

      // 4. Closing â€” ç· ã‚
      const closingFn = pickRandom(pool.closings);
      const closing = closingFn(lecture);

      // çµ„ã¿ç«‹ã¦
      let parts = [opener, ...bodyTexts, reflection, closing];

      // èªå°¾å¤‰æ›ï¼ˆstyleDataã«åŸºã¥ãï¼‰
      let output = parts.join('');
      output = applyEndingStyle(output, ending);

      return output;
    }

    function applyEndingStyle(text, ending) {
      if (ending === 'da') {
        // ã§ã™â†’ã , ã¾ã—ãŸâ†’ãŸ, ã§ã—ãŸâ†’ã ã£ãŸ
        text = text.replace(/ã§ã™ã€‚/g, 'ã ã€‚');
        text = text.replace(/ã§ã—ãŸã€‚/g, 'ã ã£ãŸã€‚');
        text = text.replace(/ã¾ã—ãŸã€‚/g, 'ãŸã€‚');
        text = text.replace(/ã¦ã„ã¾ã™/g, 'ã¦ã„ã‚‹');
        text = text.replace(/ã¾ã›ã‚“/g, 'ãªã„');
      } else if (ending === 'desu') {
        // ã ã€‚â†’ã§ã™ã€‚, ã£ãŸã€‚â†’ã¾ã—ãŸã€‚ (selective)
        text = text.replace(/ã¨æ€ã†ã€‚/g, 'ã¨æ€ã„ã¾ã™ã€‚');
        text = text.replace(/ã¨æ„Ÿã˜ãŸã€‚/g, 'ã¨æ„Ÿã˜ã¾ã—ãŸã€‚');
        text = text.replace(/ã ã‚ã†ã€‚/g, 'ã§ã—ã‚‡ã†ã€‚');
      }
      // mixed: ãã®ã¾ã¾
      return text;
    }

    /* Legacy wrappers â€” buildCommentPaper ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ */
    function generate10(lecture, main, sub, ending, kw) {
      return generateFromPool(lecture, main, sub, ending, 1, kw);
    }
    function generate30(lecture, main, sub, ending, conn, kw) {
      return generateFromPool(lecture, main, sub, ending, 2, kw);
    }
    function generate50(lecture, main, sub, ending, conn, kw) {
      return generateFromPool(lecture, main, sub, ending, 3, kw);
    }
    function generate70(lecture, main, sub, ending, conn, kw) {
      return generateFromPool(lecture, main, sub, ending, 4, kw);
    }
    function generate90(lecture, main, sub, ending, conn, kw) {
      return generateFromPool(lecture, main, sub, ending, 5, kw);
    }

    /* ============================================
       DEPARTMENT TONE
       ============================================ */
    function applyDeptTone(text, dept) {
      switch (dept) {
        case 'science-eng':
          // ç†ç³»ãƒ»å·¥å­¦éƒ¨: ãƒ‡ãƒ¼ã‚¿ãƒ»è«–ç†é‡è¦–ã€æ„Ÿæƒ…èªã‚’æŠ‘åˆ¶
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'èˆˆå‘³æ·±ã„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã ã£ãŸ')
            .replace(/é¢ç™½ã„/g, 'åˆç†çš„ãªæ§‹é€ ã‚’æŒã¤')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®åŠ¹ç‡æ€§ã«ã¤ã„ã¦æ¤œè¨ã®ä½™åœ°ãŒã‚ã‚‹')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'ãƒ‡ãƒ¼ã‚¿ãŒç¤ºã™å‚¾å‘ã‹ã‚‰èª­ã¿å–ã‚‹ã“ã¨ãŒã§ããŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'å®šé‡çš„ãªè¦³ç‚¹ã‹ã‚‰æ³¨ç›®ã«å€¤ã™')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®è§£æ˜ã«å‘ã‘ã¦åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚„æ•°å€¤çš„æ ¹æ‹ ');
          break;
        case 'social-psych':
          // ç¤¾ä¼šãƒ»å¿ƒç†å­¦éƒ¨: äººé–“è¡Œå‹•ãƒ»ç¤¾ä¼šæ§‹é€ ã®è¦–ç‚¹
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'ç¤¾ä¼šçš„èƒŒæ™¯ã‚’è€ƒãˆã‚‹ã¨ç¤ºå”†çš„ã ã£ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®å¿ƒç†çš„è¦å› ã«ã¤ã„ã¦ã•ã‚‰ã«è€ƒå¯Ÿã—ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'äººé–“ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã„ã†è¦³ç‚¹ã‹ã‚‰æ–°ãŸãªæ°—ã¥ãã‚’å¾—ãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'ç¤¾ä¼šæ§‹é€ ã¨ã®é–¢é€£ã§è€ƒãˆã‚‹ã¨å°è±¡çš„ã§ã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ç¤¾ä¼šçš„ãƒ»å¿ƒç†çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚„èª¿æŸ»ãƒ‡ãƒ¼ã‚¿');
          break;
        case 'econ-biz':
          // çµŒæ¸ˆãƒ»çµŒå–¶å­¦éƒ¨: ã‚³ã‚¹ãƒˆãƒ»å¸‚å ´ãƒ»åŠ¹ç‡ãƒ»ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'å®Ÿç”¨æ€§ã®è¦³ç‚¹ã‹ã‚‰æœ‰ç›Šã ã£ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®è²»ç”¨å¯¾åŠ¹æœã‚„å¸‚å ´ã¸ã®å½±éŸ¿ã‚’æ¤œè¨ã—ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–æ§‹é€ ã®é¢ã‹ã‚‰å†èªè­˜ã•ã›ã‚‰ã‚ŒãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'çµŒæ¸ˆçš„åˆç†æ€§ã®è¦³ç‚¹ã‹ã‚‰æ³¨ç›®ã™ã¹ãã§ã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'å¸‚å ´ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨åŠ¹ç‡æ€§ã®åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚„ä¼æ¥­äº‹ä¾‹');
          break;
        case 'literature-phil':
          // æ–‡å­¦ãƒ»å“²å­¦éƒ¨: èªå½™è±Šã‹ã€æŠ½è±¡çš„ãƒ»æ€ç´¢çš„
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'æ·±ã„ç¤ºå”†ã‚’å«ã‚“ã§ã„ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®æ ¹åº•ã«ã‚ã‚‹æ€æƒ³ã«ã¤ã„ã¦æ€ç´¢ã‚’å·¡ã‚‰ã›ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'æ¦‚å¿µã®å†å®šç¾©ã‚’è¿«ã‚‰ã‚Œã‚‹ã‚ˆã†ãªçŸ¥çš„åˆºæ¿€ã‚’å—ã‘ãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'è¨€è‘‰ã®å¤šå±¤çš„ãªæ„å‘³åˆã„ã¨ã—ã¦å°è±¡æ·±ãã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ãƒ†ã‚¯ã‚¹ãƒˆã®èª­ã¿ã‚’æ·±ã‚ã€æ€ç´¢ã®å°„ç¨‹ã‚’åºƒã’ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'æ–‡å­¦ä½œå“ã‚„å“²å­¦çš„ãƒ†ã‚¯ã‚¹ãƒˆ');
          break;
      }
      return text;
    }

    /* ============================================
       COPY TO CLIPBOARD
       ============================================ */
    function copyResult() {
      const text = document.getElementById('result-text').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copy-feedback');
        feedback.classList.add('show');
        setTimeout(() => feedback.classList.remove('show'), 2500);
      });
    }
  </script>

  <footer style="margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid #eee;">
    <p id="footer-disclaimer" style="font-size: 10px; color: #aaa; max-width: 700px; margin: 0 auto; line-height: 1.6;">
    </p>
  </footer>

  <script>
    // ãƒ•ãƒƒã‚¿ãƒ¼å…è²¬äº‹é …ã®è¨€èªåˆ‡æ›¿
    function updateFooterDisclaimer() {
      const el = document.getElementById('footer-disclaimer');
      if (!el) return;
      if (currentLang === 'en') {
        el.innerHTML = '<strong>Academic Integrity Notice:</strong> AIcomment is a <em>drafting assistant</em> designed to help you organize and refine your own ideas. '
          + 'It mimics <em>your</em> writing styleâ€”it does <strong>not</strong> generate or cite fake academic papers. '
          + '<strong>Prevents hallucinations</strong> by design: no fabricated references, no invented quotes. '
          + 'Always review and edit the output before submission, and comply with your institution\'s AI usage policies.';
      } else {
        el.innerHTML = 'Disclaimer: æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ–‡ç« ä½œæˆã®è£œåŠ©ãƒ»æ¨æ•²ã‚’ç›®çš„ã¨ã—ãŸã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ»ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã™ã€‚'
          + 'æ¶ç©ºã®è«–æ–‡å¼•ç”¨ã‚„æ•é€ ã•ã‚ŒãŸå¼•ç”¨ã‚’ç”Ÿæˆã—ãªã„èª å®Ÿãªè¨­è¨ˆã§ã™ã€‚'
          + 'ç”Ÿæˆå†…å®¹ã¯å¿…ãšã”è‡ªèº«ã§ç¢ºèªã—ã€å„æ©Ÿé–¢ã®ãƒãƒªã‚·ãƒ¼ã‚’éµå®ˆã—ãŸä¸Šã§ã€ä¸‹æ›¸ãã‚„æ§‹æˆã®å‚è€ƒã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚';
      }
    }
    // åˆå›è¡¨ç¤º
    updateFooterDisclaimer();
  </script>

</body>

</html>